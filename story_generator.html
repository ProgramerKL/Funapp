<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üìö Interactive AI Story Generator üìö</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Georgia', 'Times New Roman', serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 50%, #7e22ce 100%);
            min-height: 100vh;
            padding: 20px;
            position: relative;
            overflow-x: hidden;
        }

        /* Animated background particles */
        .particle {
            position: absolute;
            width: 3px;
            height: 3px;
            background: rgba(255, 255, 255, 0.6);
            border-radius: 50%;
            animation: float 20s infinite ease-in-out;
            pointer-events: none;
        }

        @keyframes float {
            0%, 100% {
                transform: translateY(0) translateX(0);
                opacity: 0.3;
            }
            50% {
                transform: translateY(-100vh) translateX(50px);
                opacity: 0.8;
            }
        }

        /* Back to Gallery Button - Story/Book Theme */
        .back-button {
            position: fixed;
            top: 20px;
            left: 20px;
            background: linear-gradient(145deg, #8B4513, #A0522D);
            border: 3px solid #F5DEB3;
            color: #fff;
            padding: 14px 24px;
            border-radius: 50px;
            cursor: pointer;
            font-weight: 700;
            font-size: 1rem;
            transition: all 0.3s ease;
            z-index: 10000;
            box-shadow: 0 4px 15px rgba(139, 69, 19, 0.5), inset 0 2px 0 rgba(255, 255, 255, 0.3);
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-family: 'Georgia', serif;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .back-button::before {
            content: 'üìñ';
            font-size: 1.2em;
            animation: book-flip 2s ease-in-out infinite;
        }

        @keyframes book-flip {
            0%, 100% { transform: rotateY(0deg); }
            50% { transform: rotateY(180deg); }
        }

        .back-button:hover {
            background: linear-gradient(145deg, #A0522D, #8B4513);
            transform: translateY(-2px) scale(1.08);
            box-shadow: 0 6px 25px rgba(139, 69, 19, 0.7), inset 0 2px 0 rgba(255, 255, 255, 0.4);
        }

        #gameContainer {
            background: rgba(255, 255, 255, 0.98);
            border-radius: 30px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
            padding: 40px;
            max-width: 1200px;
            margin: 80px auto 20px;
            position: relative;
        }

        #header {
            text-align: center;
            margin-bottom: 30px;
        }

        #header h1 {
            font-size: 42px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 10px;
        }

        #header p {
            color: #666;
            font-size: 16px;
            font-style: italic;
        }

        .api-config {
            background: linear-gradient(135deg, #fff9e6 0%, #ffe8b3 100%);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            border: 2px solid #FFB84D;
        }

        .api-config h3 {
            font-size: 18px;
            color: #FF9800;
            margin-bottom: 15px;
        }

        .api-input-group {
            margin-bottom: 12px;
        }

        .api-input-group label {
            display: block;
            font-size: 13px;
            font-weight: bold;
            color: #666;
            margin-bottom: 5px;
        }

        .api-input-group input {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            font-family: monospace;
        }

        .api-input-group input:focus {
            outline: none;
            border-color: #FF9800;
        }

        .api-status {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
            margin-left: 10px;
        }

        .api-status.ready {
            background: #4CAF50;
            color: white;
        }

        .api-status.not-ready {
            background: #FF5252;
            color: white;
        }

        .toggle-config {
            cursor: pointer;
            color: #667eea;
            text-decoration: underline;
            font-size: 14px;
            margin-top: 10px;
            display: inline-block;
        }

        .toggle-config:hover {
            color: #764ba2;
        }

        .story-display {
            background: #fff;
            border-radius: 20px;
            padding: 30px;
            min-height: 300px;
            max-height: 500px;
            overflow-y: auto;
            box-shadow: inset 0 2px 10px rgba(0, 0, 0, 0.05);
            border: 2px solid #e0e0e0;
            margin-bottom: 20px;
        }

        .story-segment {
            margin-bottom: 25px;
            padding: 20px;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 20%);
            border-radius: 15px;
            border-left: 5px solid #667eea;
            animation: fadeIn 0.5s ease;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .user-prompt {
            background: linear-gradient(135deg, #fff5e6 0%, #ffe0b3 20%);
            border-left-color: #FF9800;
            font-style: italic;
            color: #555;
        }

        .ai-response {
            font-size: 18px;
            line-height: 1.8;
            color: #333;
        }

        .continuation-suggestions {
            background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 20%);
            border-left: 5px solid #4CAF50;
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
            animation: fadeIn 0.5s ease;
        }

        .continuation-suggestions h4 {
            font-size: 16px;
            color: #2E7D32;
            margin-bottom: 15px;
            font-weight: bold;
        }

        .suggestion-option {
            background: white;
            border: 2px solid #4CAF50;
            border-radius: 10px;
            padding: 12px 16px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: start;
            gap: 10px;
        }

        .suggestion-option:hover {
            background: #4CAF50;
            color: white;
            transform: translateX(5px);
            box-shadow: 0 4px 12px rgba(76, 175, 80, 0.3);
        }

        .suggestion-number {
            font-weight: bold;
            font-size: 18px;
            min-width: 25px;
        }

        .suggestion-text {
            flex: 1;
            line-height: 1.5;
        }

        .segment-label {
            font-size: 12px;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .user-prompt .segment-label {
            color: #FF9800;
        }

        .input-section {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 20px;
        }

        #userPrompt {
            width: 100%;
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 15px;
            font-size: 16px;
            font-family: 'Georgia', serif;
            resize: vertical;
            min-height: 100px;
            transition: border-color 0.3s;
        }

        #userPrompt:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .button-group {
            display: flex;
            gap: 15px;
            margin-top: 15px;
        }

        .btn {
            flex: 1;
            padding: 15px;
            border: none;
            border-radius: 15px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'Georgia', serif;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }

        #continueBtn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        #continueBtn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        #startOverBtn {
            background: linear-gradient(135deg, #FF6B6B, #EE5A6F);
            color: white;
        }

        #startOverBtn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255, 107, 107, 0.4);
        }

        #exportBtn {
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
        }

        #exportBtn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(76, 175, 80, 0.4);
        }

        .loading {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 20px;
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
            border-radius: 15px;
            margin: 20px 0;
            border-left: 5px solid #2196F3;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-text {
            font-size: 16px;
            color: #1976D2;
            font-weight: bold;
        }

        .stats {
            display: flex;
            justify-content: space-around;
            padding: 20px;
            background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%);
            border-radius: 15px;
            margin-bottom: 20px;
        }

        .stat-item {
            text-align: center;
        }

        .stat-value {
            font-size: 32px;
            font-weight: bold;
            color: #FF9800;
        }

        .stat-label {
            font-size: 14px;
            color: #666;
            margin-top: 5px;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }

        .empty-state h2 {
            font-size: 48px;
            margin-bottom: 20px;
        }

        .suggestions {
            background: #f9f9f9;
            border-radius: 15px;
            padding: 20px;
            margin-top: 15px;
        }

        .suggestions h3 {
            font-size: 16px;
            color: #667eea;
            margin-bottom: 15px;
        }

        .suggestion-chips {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .chip {
            padding: 8px 16px;
            background: white;
            border: 2px solid #667eea;
            border-radius: 20px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
            color: #667eea;
        }

        .chip:hover {
            background: #667eea;
            color: white;
            transform: translateY(-2px);
        }

        .notification {
            position: fixed;
            top: 100px;
            right: 20px;
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
            padding: 15px 25px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            z-index: 10001;
            animation: slideIn 0.3s ease;
            font-weight: bold;
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @media (max-width: 768px) {
            .button-group {
                flex-direction: column;
            }

            #header h1 {
                font-size: 32px;
            }

            .stats {
                flex-direction: column;
                gap: 15px;
            }
        }
    </style>
</head>
<body>
    <!-- Back to Gallery Button -->
    <a href="index.html" class="back-button">Back to Gallery</a>

    <!-- Background particles -->
    <script>
        for (let i = 0; i < 30; i++) {
            const particle = document.createElement('div');
            particle.className = 'particle';
            particle.style.left = Math.random() * 100 + '%';
            particle.style.animationDelay = Math.random() * 20 + 's';
            particle.style.animationDuration = (15 + Math.random() * 10) + 's';
            document.body.appendChild(particle);
        }
    </script>

    <div id="gameContainer">
        <div id="header">
            <h1>üìö Interactive AI Story Generator üìö</h1>
            <p>"Your imagination shapes the story. FREE AI brings it to life."</p>
        </div>

        <div class="api-config" id="apiConfig">
            <h3>üéâ OpenRouter AI Story Generator <span class="api-status not-ready" id="apiStatus">Setup Required</span></h3>
            <div style="font-size: 14px; color: #666; margin-top: 10px;">
                <div class="api-input-group">
                    <label style="display: block; font-weight: bold; margin-bottom: 5px;">OpenRouter API Key (FREE Credits!):</label>
                    <input type="password" id="geminiApiKey" placeholder="sk-or-v1-..."
                           style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 8px; font-family: monospace;">
                </div>
                <br>
                ‚ÑπÔ∏è <strong>Get your FREE API key in 30 seconds (NO credit card!):</strong><br>
                1. Go to <a href="https://openrouter.ai/keys" target="_blank" style="color: #667eea; font-weight: bold;">openrouter.ai/keys</a><br>
                2. Sign up with Google/GitHub<br>
                3. You get FREE CREDITS automatically (no credit card!)<br>
                4. Click "Create Key" and copy it<br>
                5. Paste above and start generating stories!<br>
                <br>
                ‚úÖ Real AI generation - not templates<br>
                ‚úÖ FREE credits included - no credit card<br>
                ‚úÖ Actually works reliably<br>
                ‚úÖ Fast AI story generation<br>
            </div>
            <span class="toggle-config" id="toggleConfig">Hide Info</span>
        </div>

        <div class="stats">
            <div class="stat-item">
                <div class="stat-value" id="segmentCount">0</div>
                <div class="stat-label">Story Segments</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="wordCount">0</div>
                <div class="stat-label">Total Words</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="promptCount">0</div>
                <div class="stat-label">Your Prompts</div>
            </div>
        </div>

        <div class="story-display" id="storyDisplay">
            <div class="empty-state">
                <h2>‚ú®</h2>
                <p style="font-size: 20px; margin-bottom: 10px;"><strong>Start Your Story</strong></p>
                <p style="font-size: 16px;">Describe what you want to happen, and the AI will continue the story!</p>
            </div>
        </div>

        <div class="input-section">
            <textarea
                id="userPrompt"
                placeholder="Start your story! Describe a character, setting, action, or scenario...&#10;&#10;Examples:&#10;‚Ä¢ 'A young hero discovers they have magical powers'&#10;‚Ä¢ 'In a dystopian future, a rebellion is brewing'&#10;‚Ä¢ 'A detective investigates a mysterious murder in Victorian London'&#10;&#10;After each generation, you'll get 3 suggestions for what to write next!"></textarea>

            <div class="button-group">
                <button class="btn" id="continueBtn">‚ú® Continue Story ‚ú®</button>
                <button class="btn" id="startOverBtn">üîÑ Start Over</button>
                <button class="btn" id="exportBtn">üíæ Export Story</button>
            </div>
        </div>
    </div>

    <script>
        let storySegments = [];
        let userPrompts = 0;
        let totalWords = 0;

        const storyDisplay = document.getElementById('storyDisplay');
        const userPromptInput = document.getElementById('userPrompt');
        const continueBtn = document.getElementById('continueBtn');
        const startOverBtn = document.getElementById('startOverBtn');
        const exportBtn = document.getElementById('exportBtn');
        const segmentCountEl = document.getElementById('segmentCount');
        const wordCountEl = document.getElementById('wordCount');
        const promptCountEl = document.getElementById('promptCount');

        const apiConfigDiv = document.getElementById('apiConfig');
        const toggleConfigBtn = document.getElementById('toggleConfig');
        const apiStatus = document.getElementById('apiStatus');

        // Toggle config visibility
        toggleConfigBtn.addEventListener('click', () => {
            if (apiConfigDiv.style.display === 'none') {
                apiConfigDiv.style.display = 'block';
                toggleConfigBtn.textContent = 'Hide Info';
            } else {
                apiConfigDiv.style.display = 'none';
                toggleConfigBtn.textContent = 'Show Info';
            }
        });

        // Load and save API key
        const geminiApiKeyInput = document.getElementById('geminiApiKey');
        const savedApiKey = localStorage.getItem('openrouterApiKey');
        if (savedApiKey) {
            geminiApiKeyInput.value = savedApiKey;
            updateApiStatus();
        }

        geminiApiKeyInput.addEventListener('input', () => {
            const key = geminiApiKeyInput.value.trim();
            if (key) {
                localStorage.setItem('openrouterApiKey', key);
            }
            updateApiStatus();
        });

        function updateApiStatus() {
            const key = geminiApiKeyInput.value.trim();
            if (key && key.length > 20) {
                apiStatus.className = 'api-status ready';
                apiStatus.textContent = '‚úÖ Ready';
            } else {
                apiStatus.className = 'api-status not-ready';
                apiStatus.textContent = 'Setup Required';
            }
        }

        // Call OpenRouter API (FREE credits included!)
        async function callOpenRouterAI(prompt) {
            const apiKey = geminiApiKeyInput.value.trim();

            if (!apiKey || apiKey.length < 20) {
                console.log('No OpenRouter API key provided');
                return null;
            }

            try {
                console.log('Calling OpenRouter AI...');
                showNotification('ü§ñ Generating story with AI... Please wait...', '#2196F3');

                const response = await fetch('https://openrouter.ai/api/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`,
                        'HTTP-Referer': 'https://github.com/yourusername/story-generator',
                        'X-Title': 'AI Story Generator'
                    },
                    body: JSON.stringify({
                        model: 'google/gemma-2-9b-it:free',
                        messages: [
                            {
                                role: 'system',
                                content: 'You are a creative story writer. Write engaging, vivid, and imaginative stories with descriptive details.'
                            },
                            {
                                role: 'user',
                                content: prompt
                            }
                        ],
                        max_tokens: 500,
                        temperature: 0.9,
                        route: 'fallback'
                    })
                });

                const result = await response.json();
                console.log('OpenRouter response status:', response.status);
                console.log('OpenRouter response:', result);

                if (response.ok && result.choices && result.choices[0]) {
                    const text = result.choices[0].message.content;
                    if (text && text.trim().length > 30) {
                        console.log('‚úÖ Success with OpenRouter!');
                        showNotification('‚úÖ Story generated successfully!', '#4CAF50');
                        return text.trim();
                    }
                } else if (result.error) {
                    console.error('OpenRouter error:', result.error);
                    console.error('Error code:', result.error.code);
                    console.error('Error message:', result.error.message);
                    console.error('Error metadata:', result.error.metadata);
                    const errorMsg = result.error.message || JSON.stringify(result.error);
                    showNotification(`‚ùå OpenRouter Error: ${errorMsg}`, '#FF5252');
                    console.error('Full error details:', JSON.stringify(result, null, 2));
                } else {
                    console.error('Unexpected response:', JSON.stringify(result, null, 2));
                    showNotification(`‚ùå Unexpected error. Check console for details.`, '#FF5252');
                }

                return null;
            } catch (error) {
                console.error('OpenRouter error:', error);
                showNotification('‚ùå Network error. Please check your connection.', '#FF5252');
                return null;
            }
        }

        // Advanced story generation using OpenRouter AI
        async function generateStoryFromPrompt(userInput, previousContext) {
            const isFirstSegment = previousContext.trim().length === 0;

            // Build prompt for AI
            let prompt;
            if (isFirstSegment) {
                prompt = `Write a creative and engaging story based on this idea: ${userInput}

Create 2-3 vivid paragraphs with descriptive details and interesting characters.`;
            } else {
                const recentContext = previousContext.slice(-400);
                prompt = `Continue this story: ${recentContext}

${userInput}

Write 2-3 more paragraphs continuing the story naturally.`;
            }

            // Try to get AI-generated content from OpenRouter
            console.log('Calling OpenRouter AI...');
            const aiGenerated = await callOpenRouterAI(prompt);

            if (aiGenerated && aiGenerated.trim().length > 30) {
                console.log('Got AI response from OpenRouter!');
                return aiGenerated.trim();
            }

            // If API key is not set, show helpful message
            const apiKey = geminiApiKeyInput.value.trim();
            if (!apiKey || apiKey.length < 20) {
                throw new Error('Please enter your FREE OpenRouter API key above! Get it at openrouter.ai/keys (no credit card needed)');
            }

            // If we get here, the API call failed
            throw new Error('Unable to generate story. Please check your API key and try again.');
        }

        // Generate 3 contextual continuation suggestions based on current story themes
        function generateContinuationSuggestions(currentStory) {
            // Analyze the current story to detect themes
            const storyLower = currentStory.toLowerCase();

            const themes = {
                character: /character|person|protagonist|villain|warrior|hero|they|he|she/i.test(currentStory),
                action: /fight|battle|struggle|confront|chase|escape|attack|defend/i.test(currentStory),
                mystery: /mystery|secret|hidden|discover|reveal|clue|investigate|truth/i.test(currentStory),
                magic: /magic|power|spell|wizard|enchant|curse|supernatural|mystical/i.test(currentStory),
                emotion: /love|fear|anger|joy|emotion|feeling|heart|trust|hope|despair/i.test(currentStory),
                setting: /world|realm|city|forest|castle|environment|location|place/i.test(currentStory),
                conflict: /enemy|danger|threat|oppose|rival|confrontation|tension/i.test(currentStory),
                relationship: /relationship|bond|connection|friendship|alliance|betrayal/i.test(currentStory)
            };

            // Create contextual suggestion pools
            const suggestionPools = {
                character: [
                    "A character reveals their true motives, recontextualizing their previous actions",
                    "Someone's hidden past emerges, explaining their current behavior",
                    "A character makes a choice that surprises everyone, including themselves",
                    "Internal conflict forces a character to confront their deepest fears",
                    "A moment of vulnerability reveals unexpected depth in a character"
                ],
                action: [
                    "A confrontation erupts, forcing everyone to choose sides",
                    "An unexpected threat demands immediate action",
                    "A daring escape plan is put into motion with high stakes",
                    "The situation escalates beyond anyone's control",
                    "A critical moment requires split-second decisions with lasting consequences"
                ],
                mystery: [
                    "A crucial piece of evidence is discovered that changes everything",
                    "Seemingly unrelated clues suddenly connect, revealing a larger pattern",
                    "Someone is not who they claimed to be, and the deception unravels",
                    "A hidden truth emerges that reframes the entire situation",
                    "A small detail from earlier takes on massive significance"
                ],
                magic: [
                    "Magical forces manifest in unexpected and dangerous ways",
                    "An ancient power awakens with unclear intentions",
                    "The cost of using magic becomes devastatingly clear",
                    "Reality bends in ways that shouldn't be possible",
                    "A magical artifact or ability reveals its true nature"
                ],
                emotion: [
                    "A heartfelt moment forces honesty about true feelings",
                    "Suppressed emotions finally break through, changing relationships",
                    "A difficult conversation reveals unexpected common ground",
                    "Trust is tested to its breaking point",
                    "A sacrifice demonstrates the depth of someone's commitment"
                ],
                setting: [
                    "The environment itself becomes an active threat or ally",
                    "A new location is discovered with secrets of its own",
                    "The setting transforms in response to events",
                    "Natural or supernatural forces create new challenges",
                    "The location reveals hidden connections to the story"
                ],
                conflict: [
                    "Opposing forces meet in direct confrontation",
                    "A betrayal shifts alliances and power dynamics",
                    "The true enemy reveals themselves",
                    "A moral dilemma creates internal division",
                    "Escalating tensions reach a breaking point"
                ],
                relationship: [
                    "A relationship fundamentally changes due to recent events",
                    "An unlikely alliance forms out of necessity",
                    "Past connections resurface in the present",
                    "Trust between characters is tested or shattered",
                    "A bond deepens through shared adversity"
                ],
                general: [
                    "An unexpected visitor arrives with crucial information",
                    "Time pressure creates urgency as a deadline approaches",
                    "What seemed certain is revealed to be a misunderstanding",
                    "A choice must be made between two equally important values",
                    "The situation spirals in an unforeseen direction",
                    "A perspective shift reveals a different interpretation of events",
                    "Something from the past returns to complicate the present",
                    "The stakes suddenly increase dramatically"
                ]
            };

            // Select suggestions based on detected themes
            let suggestions = [];
            let themesDetected = [];

            // Identify which themes are present
            for (const [theme, isPresent] of Object.entries(themes)) {
                if (isPresent && suggestionPools[theme]) {
                    themesDetected.push(theme);
                }
            }

            // If we have detected themes, use them
            if (themesDetected.length > 0) {
                // Shuffle detected themes
                themesDetected.sort(() => Math.random() - 0.5);

                // Get one suggestion from each detected theme (up to 3)
                for (let i = 0; i < Math.min(3, themesDetected.length); i++) {
                    const theme = themesDetected[i];
                    const pool = suggestionPools[theme];
                    const suggestion = pool[Math.floor(Math.random() * pool.length)];
                    if (!suggestions.includes(suggestion)) {
                        suggestions.push(suggestion);
                    }
                }
            }

            // Fill remaining slots with general suggestions
            while (suggestions.length < 3) {
                const generalPool = suggestionPools.general;
                const suggestion = generalPool[Math.floor(Math.random() * generalPool.length)];
                if (!suggestions.includes(suggestion)) {
                    suggestions.push(suggestion);
                }
            }

            return suggestions.slice(0, 3);
        }

        function addContinuationSuggestions(suggestions) {
            const suggestionsDiv = document.createElement('div');
            suggestionsDiv.className = 'continuation-suggestions';

            suggestionsDiv.innerHTML = `
                <h4>üí° What happens next? Choose a direction:</h4>
            `;

            suggestions.forEach((suggestion, index) => {
                const option = document.createElement('div');
                option.className = 'suggestion-option';
                option.dataset.suggestion = suggestion;
                option.innerHTML = `
                    <div class="suggestion-number">${index + 1}.</div>
                    <div class="suggestion-text">${suggestion}</div>
                `;

                option.addEventListener('click', () => {
                    userPromptInput.value = suggestion;
                    userPromptInput.focus();
                    userPromptInput.scrollIntoView({ behavior: 'smooth', block: 'center' });

                    // Highlight the textarea briefly
                    userPromptInput.style.borderColor = '#4CAF50';
                    userPromptInput.style.boxShadow = '0 0 0 3px rgba(76, 175, 80, 0.3)';
                    setTimeout(() => {
                        userPromptInput.style.borderColor = '';
                        userPromptInput.style.boxShadow = '';
                    }, 1000);
                });

                suggestionsDiv.appendChild(option);
            });

            storyDisplay.appendChild(suggestionsDiv);
            storyDisplay.scrollTop = storyDisplay.scrollHeight;
        }

        function showLoading() {
            const loading = document.createElement('div');
            loading.className = 'loading';
            loading.id = 'loadingIndicator';
            loading.innerHTML = `
                <div class="loading-spinner"></div>
                <div class="loading-text">ü§ñ AI is crafting your story...</div>
            `;
            storyDisplay.appendChild(loading);
            storyDisplay.scrollTop = storyDisplay.scrollHeight;
        }

        function hideLoading() {
            const loading = document.getElementById('loadingIndicator');
            if (loading) loading.remove();
        }

        function addStorySegment(text, isUserPrompt = false) {
            const segment = document.createElement('div');
            segment.className = isUserPrompt ? 'story-segment user-prompt' : 'story-segment ai-response';

            const label = isUserPrompt ? 'üë§ YOUR PROMPT' : 'ü§ñ AI CONTINUES';
            segment.innerHTML = `
                <div class="segment-label">${label}</div>
                <div>${text}</div>
            `;

            storyDisplay.appendChild(segment);
            storyDisplay.scrollTop = storyDisplay.scrollHeight;

            // Update stats
            const wordCount = text.split(' ').length;
            totalWords += wordCount;

            if (!isUserPrompt) {
                storySegments.push({ type: 'ai', text: text });
            } else {
                storySegments.push({ type: 'user', text: text });
                userPrompts++;
            }

            updateStats();
        }

        function updateStats() {
            segmentCountEl.textContent = storySegments.length;
            wordCountEl.textContent = totalWords;
            promptCountEl.textContent = userPrompts;
        }

        function clearEmptyState() {
            const emptyState = storyDisplay.querySelector('.empty-state');
            if (emptyState) emptyState.remove();
        }

        continueBtn.addEventListener('click', async () => {
            const userInput = userPromptInput.value.trim();

            if (!userInput) {
                showNotification('‚ö†Ô∏è Please enter a prompt first!', '#FF9800');
                return;
            }

            // Disable button and show loading
            continueBtn.disabled = true;
            clearEmptyState();

            // Add user prompt
            addStorySegment(userInput, true);

            // Show loading
            showLoading();

            try {
                // Generate AI continuation with dynamic content
                const previousContext = storySegments.map(s => s.text).join(' ');
                const aiResponse = await generateStoryFromPrompt(userInput, previousContext);

                hideLoading();

                // Always add the response (fallback ensures we always get something)
                if (aiResponse && aiResponse.trim().length > 0) {
                    addStorySegment(aiResponse, false);

                    // Clear input and re-enable button
                    userPromptInput.value = '';
                    continueBtn.disabled = false;
                    userPromptInput.focus();
                } else {
                    showNotification('‚ùå Could not generate story. Please try again.', '#FF5252');
                    continueBtn.disabled = false;
                }
            } catch (error) {
                hideLoading();
                showNotification('‚ùå Error generating story. Please try again.', '#FF5252');
                continueBtn.disabled = false;
                console.error('Story generation error:', error);
            }
        });

        startOverBtn.addEventListener('click', () => {
            if (storySegments.length > 0) {
                if (!confirm('Are you sure you want to start over? Your current story will be lost.')) {
                    return;
                }
            }

            storySegments = [];
            userPrompts = 0;
            totalWords = 0;
            storyDisplay.innerHTML = `
                <div class="empty-state">
                    <h2>‚ú®</h2>
                    <p style="font-size: 20px; margin-bottom: 10px;"><strong>Start Your Story</strong></p>
                    <p style="font-size: 16px;">Describe what you want to happen, and the AI will continue the story!</p>
                </div>
            `;
            updateStats();
            userPromptInput.value = '';
            showNotification('‚úÖ Story reset! Ready for a new adventure.');
        });

        exportBtn.addEventListener('click', () => {
            if (storySegments.length === 0) {
                showNotification('‚ö†Ô∏è No story to export yet!', '#FF9800');
                return;
            }

            let fullStory = 'üìö MY AI-GENERATED STORY üìö\n\n';
            fullStory += `Generated: ${new Date().toLocaleString()}\n`;
            fullStory += `Total Segments: ${storySegments.length}\n`;
            fullStory += `Total Words: ${totalWords}\n`;
            fullStory += `Your Prompts: ${userPrompts}\n`;
            fullStory += '\n' + '='.repeat(60) + '\n\n';

            storySegments.forEach((segment, index) => {
                if (segment.type === 'user') {
                    fullStory += `\n[YOUR PROMPT #${Math.floor(index/2) + 1}]\n`;
                    fullStory += `${segment.text}\n`;
                } else {
                    fullStory += `\n[AI CONTINUATION]\n`;
                    fullStory += `${segment.text}\n`;
                }
            });

            const blob = new Blob([fullStory], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `ai-story-${Date.now()}.txt`;
            a.click();
            URL.revokeObjectURL(url);

            showNotification('‚úÖ Story exported successfully!');
        });

        // Enter key to continue (Ctrl+Enter)
        userPromptInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && e.ctrlKey && !continueBtn.disabled) {
                continueBtn.click();
            }
        });

        function showNotification(message, color = '#4CAF50') {
            const notification = document.createElement('div');
            notification.className = 'notification';
            notification.style.background = `linear-gradient(135deg, ${color}, ${color}dd)`;
            notification.textContent = message;
            document.body.appendChild(notification);

            setTimeout(() => {
                notification.style.animation = 'slideIn 0.3s ease reverse';
                setTimeout(() => notification.remove(), 300);
            }, 2500);
        }
    </script>
</body>
</html>
